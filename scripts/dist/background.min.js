function getAllCookies(){chrome.cookies.getAll({url:"https://steamcommunity.com"},(function(e){headerCookies=e.map((function(e){return e.name+"="+e.value})).join(";")}))}function getAPIKey(e){chrome.storage.sync.get("apikey",(function(t){0==Object.keys(t).length?(console.log("Getting Steam API Key."),getNewAPIKey(e)):"function"==typeof e&&e(t.apikey)}))}function getNewAPIKey(e){chrome.cookies.get({url:"https://steamcommunity.com",name:"sessionid"},(function(t){$.ajax({method:"POST",url:"https://steamcommunity.com/dev/registerkey",data:{domain:"localhost",agreeToTerms:"agreed",sessionid:t.value,submit:"Register"},success:function(t){if("Access Denied"===$(t).find("#mainContents h2").text()&&console.log("Unable to get Steam API Key."),"Your Steam Web API Key"===$(t).find("#bodyContents_ex h2").text()){var s=$(t).find("#bodyContents_ex p").eq(0).text().split(" ")[1];console.log("Retrieved Steam API Key: "+s),"function"==typeof e&&e(s),chrome.storage.sync.set({apikey:s})}}})}))}function getNotifications(){$.ajax({url:"https://steamcommunity.com/actions/GetNotificationCounts",success:function(e){if(!e||!e.hasOwnProperty("notifications"))return setTimeout(getNotifications,15e3);var t=e.notifications;for(var s in t)if(t[s]>mappings.notifications[s]){var o=t[s]-mappings.notifications[s];chrome.storage.sync.get("volume",(function(e){e.hasOwnProperty("volume")||(e.volume=80),notificationSound.volume=e.volume/100,notificationSound.play()})),chrome.notifications.create(s,{type:"basic",title:"CS:GO Trade Helper",message:"You have "+o+" new "+mappings.names[s]+(1==o?"":"s"),iconUrl:"/assets/notification.png"})}mappings.notifications={4:t[4],5:t[5],6:t[6],7:t[7]},setTimeout(getNotifications,15e3)},error:function(){setTimeout(getNotifications,15e3)}})}function getOffers(){makeAPICall("https://api.steampowered.com/IEconService/GetTradeOffers/v1",{get_sent_offers:1,get_received_offers:1,get_descriptions:0,active_only:1,historical_only:0},(function(e){if(!e.err&&(e=e.data,0!=Object.keys(e.response).length)){var t={},s=[],o={};if(e.response.trade_offers_received.forEach((function(e){if(2==e.trade_offer_state){var i=toSteam64(e.accountid_other);if(e.items_to_receive){var n=e.items_to_receive.map((function(e){return e.assetid}));o.hasOwnProperty(i)?o[i]=o[i].concat(n):o[i]=n}if(e.items_to_give){var a=e.items_to_give.map((function(e){return e.assetid}));o.hasOwnProperty("me")?o.me=o.me.concat(a):o.me=a}if(chrome.storage.sync.get("autoaccept",(function(t){!t.autoaccept||e.items_to_give&&0!=e.items_to_give.length||(getAllCookies(),acceptOffer(e.tradeofferid,i))})),!e.is_our_offer){if(knownOffers.indexOf(e.tradeofferid)>-1)return;knownOffers.push(e.tradeofferid),s.push(i),t[i]={steamid:i,id:e.tradeofferid,message:e.message,give:e.hasOwnProperty("items_to_give")?e.items_to_give.length:0,receive:e.hasOwnProperty("items_to_receive")?e.items_to_receive.length:0}}}})),itemsInTrade=o,0==s.length)return setTimeout(getOffers,15e3);makeAPICall("https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v2",{steamids:s.join(",")},(function(e){e.err||(e=e.data,e.response.players.forEach((function(e){getBlob(e.avatarfull,(function(s){var o=t[e.steamid];chrome.storage.sync.get("volume",(function(e){e.hasOwnProperty("volume")||(e.volume=80),notificationSound.volume=e.volume/100,notificationSound.play()})),chrome.notifications.create(o.id,{type:"basic",title:"CS:GO Trade Helper",message:e.personaname+" has sent you a trade offer!"+(o.message.length>0?'\n"'+o.message+'"':""),iconUrl:s.err?"":s.data})}))})),setTimeout(getOffers,3e4))}))}}))}function acceptOffer(e,t){_gaq.push(["_trackEvent","acceptOffer","clicked"]),chrome.cookies.get({url:"https://steamcommunity.com",name:"sessionid"},(function(s){$.ajax({type:"POST",url:"https://steamcommunity.com/tradeoffer/"+e+"/accept/st-accept",data:{sessionid:s.value,serverid:1,tradeofferid:e,partner:t,captcha:""},crossDomain:!0,xhrFields:{withCredentials:!0}})}))}function makeAPICall(e,t,s){getAPIKey((function(o){t.key=o,$.ajax({url:e,data:t,success:function(e){s({err:!1,data:e})},error:function(){s({err:!0})}})}))}function getBlob(e,t){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="blob",s.onload=function(e){if(200!=this.status)return t({err:!0});var s=new window.FileReader;s.readAsDataURL(this.response),s.onloadend=function(){t({err:!1,data:s.result})}},s.send()}function getPrices(e){_gaq.push(["_trackEvent","getPrices","clicked"]);var t={fast:"https://api.csgofast.com/sih/all",backpack:"https://i7xx.xyz/api/1/prices?source=backpack",steamlytics:"http://api.csgo.steamlytics.xyz/v2/pricelist/compact?key=",bitskins:"https://i7xx.xyz/api/1/prices?source=bitskins",steamapiscom:"http://api.steamapis.com/market/items/730?format=compact&api_key=",steamapiio:"https://api.steamapi.io/market/prices/730?key="};chrome.storage.sync.get(["prices","steamlytics","steamapiscom","steamapiio"],(function(s){var o=s.hasOwnProperty("prices")?s.prices:"backpack",i=t[o];s.hasOwnProperty("steamlytics")&&"steamlytics"==o&&(i+=s.steamlytics),s.hasOwnProperty("steamapiscom")&&"steamapiscom"==o&&(i+=s.steamapiscom),s.hasOwnProperty("steamapiio")&&"steamapiio"==o&&(i+=s.steamapiio),$.ajax({url:i,success:function(t){console.log(o,i,t);var s={};if(("backpack"===o||"bitskins"==o)&&!t.success)return setTimeout(getPrices.bind(null,e),1e3);if("steamlytics"===o){if(!t.success)return setTimeout(getPrices.bind(null,e),6e5);s=t.items}"steamapiio"!==o&&"steamapiscom"!==o||t&&(s=t),e(prices=s)},error:function(){setTimeout(getPrices.bind(null,e),1e3)}})}))}function getRates(e){$.ajax({url:"https://api.fixer.io/latest?base=USD",success:function(t){e("string"==typeof t?JSON.parse(t):t)},error:function(){setTimeout(getRates.bind(null,e),500)}})}function toSteam64(e){return new UINT64(e,17825793).toString()}chrome.webRequest.onHeadersReceived.addListener((function(e){var t={"Access-Control-Allow-Origin":{value:"*",injected:!1}};e.responseHeaders.forEach((function(s,o){Object.keys(t).indexOf(s.name)!=-1&&(e.responseHeaders[o].value=t[s.name].value,t[s.name].injected=!0)}));for(var s in t){if(t[s].injected)return;e.responseHeaders.push({name:s,value:t[s].value})}return{responseHeaders:e.responseHeaders}}),{urls:["*://steamcommunity.com/*","*://api.steampowered.com/*","*://steamrep.com/*","*://api.fixer.io/*"]},["blocking","responseHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener((function(e){return{requestHeaders:[{name:"Content-Type",value:"application/x-www-form-urlencoded; charset=UTF-8"},{name:"Accept",value:"*/*"},{name:"Referer",value:e.url.replace("accept/st-accept","")},{name:"Accept-Language",value:"en-US,en;q=0.8"},{name:"Accept-Encoding",value:"gzip, deflate, br"},{name:"User-Agent",value:"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.84 Safari/537.36"},{name:"Cookie",value:headerCookies}]}}),{urls:["*://steamcommunity.com/tradeoffer/*/accept/st-accept"]},["blocking","requestHeaders"]),chrome.browserAction.onClicked.addListener((function(e){chrome.tabs.create({url:chrome.extension.getURL("settings/index.html")},(function(e){}))}));var headerCookies=[],mappings={notifications:{4:0,5:0,6:0,7:0},names:{4:"comment",5:"item",6:"friend invite",7:"gift"},urls:{4:"commentnotifications",5:"inventory",6:"home/invites",7:"inventory/#pending_gifts"}};getNotifications();var knownOffers=[],itemsInTrade={},notificationSound=new Audio("../assets/chime.mp3");chrome.storage.sync.get("sound",(function(e){e.hasOwnProperty("sound")&&(notificationSound=new Audio("../assets/"+e.sound+".mp3"))})),getOffers(),chrome.notifications.onClicked.addListener((function(e){mappings.urls[e]?window.open("https://steamcommunity.com/my/"+mappings.urls[e]):window.open("https://steamcommunity.com/tradeoffer/"+e)}));var prices={},rates={};chrome.runtime.onMessage.addListener((function(e,t,s){if("requestPrices"===e.action)0==Object.keys(prices).length?getPrices(s):s(prices);else if("updatePrices"===e.action)getPrices(console.log);else if("getAPIKey"===e.action)getAPIKey((function(e){s({data:e})}));else if("getTradeItems"===e.action){var o=itemsInTrade.hasOwnProperty(e.steamID)?itemsInTrade[e.steamID]:[];s({items:o})}else"getSettings"===e.action?chrome.storage.sync.get((function(e){s({fvdecimals:e.hasOwnProperty("fvdecimals")?e.fvdecimals:6,autoaccept:!e.hasOwnProperty("autoaccept")||e.autoaccept,intradebg:e.hasOwnProperty("intradebg")?e.intradebg:188,exchangeabbr:e.hasOwnProperty("exchangeabbr")?e.exchangeabbr:"USD",exchangesymb:e.hasOwnProperty("exchangesymb")?e.exchangesymb:"$",fontsizetop:e.hasOwnProperty("fontsizetop")?e.fontsizetop:12,fontsizebottom:e.hasOwnProperty("fontsizebottom")?e.fontsizebottom:14,volume:e.hasOwnProperty("volume")?e.volume:100,prices:e.hasOwnProperty("prices")?e.prices:"backpack",autoignore:!e.hasOwnProperty("autoignore")||e.autoignore,sound:e.hasOwnProperty("sound")?e.sound:"chime"})})):"getRates"===e.action&&(0==Object.keys(rates).length?getRates((function(e){e&&e.rates&&(e.rates.USD=1,rates=e.rates),s(rates)})):s(rates));return!0}));